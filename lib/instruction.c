#include "instruction.h"
#include "cpu.h"

#include <ulog.h>

// cycles are multiplied by 4 to convert CPU cycles to clock cycles
#define INS(disasm, opcode, op_size, cycles, exec) { disasm, opcode, op_size, (cycles) * 4, { (void*)(exec) } }


static void fgb_unimplemented_0(fgb_cpu* cpu, const fgb_instruction* ins) {
    log_error("Unimplemented instruction: %s (0x%02X) at 0x%04X", ins->disassembly, ins->opcode, cpu->regs.pc);
    cpu->halted = true;
}

static void fgb_unimplemented_1(fgb_cpu* cpu, const fgb_instruction* ins, uint8_t operand) {
    char disasm[64];
    snprintf(disasm, sizeof(disasm), ins->disassembly, operand);
    log_error("Unimplemented instruction: %s (0x%02X) at 0x%04X", disasm, ins->opcode, cpu->regs.pc);
    cpu->halted = true;
}

static void fgb_unimplemented_2(fgb_cpu* cpu, const fgb_instruction* ins, uint16_t operand) {
    char disasm[64];
    snprintf(disasm, sizeof(disasm), ins->disassembly, operand);
    log_error("Unimplemented instruction: %s (0x%02X) at 0x%04X", disasm, ins->opcode, cpu->regs.pc);
    cpu->halted = true;
}


fgb_instruction fgb_instruction_table[FGB_INSTRUCTION_COUNT] = {
    INS("NOP", 0x00, 0, 1, fgb_nop),
    INS("LD BC,0x%04X", 0x01, 2, 3, fgb_ld_bc_imm),
    INS("LD (BC),A", 0x02, 0, 2, fgb_ld_p_bc_a),
    INS("INC BC", 0x03, 0, 2, fgb_inc_bc),
    INS("INC B", 0x04, 0, 1, fgb_inc_b),
    INS("DEC B", 0x05, 0, 1, fgb_dec_b),
    INS("LD B,0x%02X", 0x06, 1, 2, fgb_ld_b_imm),
    INS("RLCA", 0x07, 0, 1, fgb_rlca),
    INS("LD (0x%04X),SP", 0x08, 2, 5, fgb_ld_p_imm_sp),
    INS("ADD HL,BC", 0x09, 0, 2, fgb_add_hl_bc),
    INS("LD A,(BC)", 0x0A, 0, 2, fgb_ld_a_p_bc),
    INS("DEC BC", 0x0B, 0, 2, fgb_dec_bc),
    INS("INC C", 0x0C, 0, 1, fgb_inc_c),
    INS("DEC C", 0x0D, 0, 1, fgb_dec_c),
    INS("LD C,0x%02X", 0x0E, 1, 2, fgb_ld_c_imm),
    INS("RRCA", 0x0F, 0, 1, fgb_rrca),

    INS("STOP", 0x10, 0, 2, fgb_stop),
    INS("LD DE,0x%04X", 0x11, 2, 3, fgb_ld_de_imm),
    INS("LD (DE),A", 0x12, 0, 2, fgb_ld_p_de_a),
    INS("INC DE", 0x13, 0, 2, fgb_inc_de),
    INS("INC D", 0x14, 0, 1, fgb_inc_d),
    INS("DEC D", 0x15, 0, 1, fgb_dec_d),
    INS("LD D,0x%02X", 0x16, 1, 2, fgb_ld_d_imm),
    INS("RLA", 0x17, 0, 1, fgb_rla),
    INS("JR 0x%02X", 0x18, 1, 2, fgb_jr),
    INS("ADD HL,DE", 0x19, 0, 2, fgb_add_hl_de),
    INS("LD A,(DE)", 0x1A, 0, 2, fgb_ld_a_p_de),
    INS("DEC DE", 0x1B, 0, 2, fgb_dec_de),
    INS("INC E", 0x1C, 0, 1, fgb_inc_e),
    INS("DEC E", 0x1D, 0, 1, fgb_dec_e),
    INS("LD E,0x%02X", 0x1E, 1, 2, fgb_ld_e_imm),
    INS("RRA", 0x1F, 0, 1, fgb_rra),

    INS("JR NZ,0x%02X", 0x20, 1, 2, fgb_jr_nz),
    INS("LD HL,0x%04X", 0x21, 2, 3, fgb_ld_hl_imm),
    INS("LD (HL+),A", 0x22, 0, 2, fgb_ld_p_hli_a),
    INS("INC HL", 0x23, 0, 2, fgb_inc_hl),
    INS("INC H", 0x24, 0, 1, fgb_inc_h),
    INS("DEC H", 0x25, 0, 1, fgb_dec_h),
    INS("LD H,0x%02X", 0x26, 1, 2, fgb_ld_h_imm),
    INS("DAA", 0x27, 0, 1, fgb_daa),
    INS("JR Z,0x%02X", 0x28, 1, 2, fgb_jr_z),
    INS("ADD HL,HL", 0x29, 0, 2, fgb_add_hl_hl),
    INS("LD A,(HL+)", 0x2A, 0, 2, fgb_ld_a_p_hli),
    INS("DEC HL", 0x2B, 0, 2, fgb_dec_hl),
    INS("INC L", 0x2C, 0, 1, fgb_inc_l),
    INS("DEC L", 0x2D, 0, 1, fgb_dec_l),
    INS("LD L,0x%02X", 0x2E, 1, 2, fgb_ld_l_imm),
    INS("CPL", 0x2F, 0, 1, fgb_cpl),

    INS("JR NC,0x%02X", 0x30, 1, 2, fgb_jr_nc),
    INS("LD SP,0x%04X", 0x31, 2, 3, fgb_ld_sp_imm),
    INS("LD (HL-),A", 0x32, 0, 2, fgb_ld_p_hld_a),
    INS("INC SP", 0x33, 0, 2, fgb_inc_sp),
    INS("INC (HL)", 0x34, 0, 3, fgb_inc_p_hl),
    INS("DEC (HL)", 0x35, 0, 3, fgb_dec_p_hl),
    INS("LD (HL),0x%02X", 0x36, 1, 3, fgb_ld_p_hl_imm),
    INS("SCF", 0x37, 0, 1, fgb_scf),
    INS("JR C,0x%02X", 0x38, 1, 2, fgb_jr_c),
    INS("ADD HL,SP", 0x39, 0, 2, fgb_add_hl_sp),
    INS("LD A,(HL-)", 0x3A, 0, 2, fgb_ld_a_p_hld),
    INS("DEC SP", 0x3B, 0, 2, fgb_dec_sp),
    INS("INC A", 0x3C, 0, 1, fgb_inc_a),
    INS("DEC A", 0x3D, 0, 1, fgb_dec_a),
    INS("LD A,0x%02X", 0x3E, 1, 2, fgb_ld_a_imm),
    INS("CCF", 0x3F, 0, 1, fgb_ccf),

    INS("LD B,B", 0x40, 0, 1, fgb_ld_b_b),
    INS("LD B,C", 0x41, 0, 1, fgb_ld_b_c),
    INS("LD B,D", 0x42, 0, 1, fgb_ld_b_d),
    INS("LD B,E", 0x43, 0, 1, fgb_ld_b_e),
    INS("LD B,H", 0x44, 0, 1, fgb_ld_b_h),
    INS("LD B,L", 0x45, 0, 1, fgb_ld_b_l),
    INS("LD B,(HL)", 0x46, 0, 2, fgb_ld_b_p_hl),
    INS("LD B,A", 0x47, 0, 1, fgb_ld_b_a),
    INS("LD C,B", 0x48, 0, 1, fgb_ld_c_b),
    INS("LD C,C", 0x49, 0, 1, fgb_ld_c_c),
    INS("LD C,D", 0x4A, 0, 1, fgb_ld_c_d),
    INS("LD C,E", 0x4B, 0, 1, fgb_ld_c_e),
    INS("LD C,H", 0x4C, 0, 1, fgb_ld_c_h),
    INS("LD C,L", 0x4D, 0, 1, fgb_ld_c_l),
    INS("LD C,(HL)", 0x4E, 0, 2, fgb_ld_c_p_hl),
    INS("LD C,A", 0x4F, 0, 1, fgb_ld_c_a),

    INS("LD D,B", 0x50, 0, 1, fgb_ld_d_b),
    INS("LD D,C", 0x51, 0, 1, fgb_ld_d_c),
    INS("LD D,D", 0x52, 0, 1, fgb_ld_d_d),
    INS("LD D,E", 0x53, 0, 1, fgb_ld_d_e),
    INS("LD D,H", 0x54, 0, 1, fgb_ld_d_h),
    INS("LD D,L", 0x55, 0, 1, fgb_ld_d_l),
    INS("LD D,(HL)", 0x56, 0, 2, fgb_ld_d_p_hl),
    INS("LD D,A", 0x57, 0, 1, fgb_ld_d_a),
    INS("LD E,B", 0x58, 0, 1, fgb_ld_e_b),
    INS("LD E,C", 0x59, 0, 1, fgb_ld_e_c),
    INS("LD E,D", 0x5A, 0, 1, fgb_ld_e_d),
    INS("LD E,E", 0x5B, 0, 1, fgb_ld_e_e),
    INS("LD E,H", 0x5C, 0, 1, fgb_ld_e_h),
    INS("LD E,L", 0x5D, 0, 1, fgb_ld_e_l),
    INS("LD E,(HL)", 0x5E, 0, 2, fgb_ld_e_p_hl),
    INS("LD E,A", 0x5F, 0, 1, fgb_ld_e_a),

    INS("LD H,B", 0x60, 0, 1, fgb_ld_h_b),
    INS("LD H,C", 0x61, 0, 1, fgb_ld_h_c),
    INS("LD H,D", 0x62, 0, 1, fgb_ld_h_d),
    INS("LD H,E", 0x63, 0, 1, fgb_ld_h_e),
    INS("LD H,H", 0x64, 0, 1, fgb_ld_h_h),
    INS("LD H,L", 0x65, 0, 1, fgb_ld_h_l),
    INS("LD H,(HL)", 0x66, 0, 2, fgb_ld_h_p_hl),
    INS("LD H,A", 0x67, 0, 1, fgb_ld_h_a),
    INS("LD L,B", 0x68, 0, 1, fgb_ld_l_b),
    INS("LD L,C", 0x69, 0, 1, fgb_ld_l_c),
    INS("LD L,D", 0x6A, 0, 1, fgb_ld_l_d),
    INS("LD L,E", 0x6B, 0, 1, fgb_ld_l_e),
    INS("LD L,H", 0x6C, 0, 1, fgb_ld_l_h),
    INS("LD L,L", 0x6D, 0, 1, fgb_ld_l_l),
    INS("LD L,(HL)", 0x6E, 0, 2, fgb_ld_l_p_hl),
    INS("LD L,A", 0x6F, 0, 1, fgb_ld_l_a),

    INS("LD (HL),B", 0x70, 0, 2, fgb_ld_p_hl_b),
    INS("LD (HL),C", 0x71, 0, 2, fgb_ld_p_hl_c),
    INS("LD (HL),D", 0x72, 0, 2, fgb_ld_p_hl_d),
    INS("LD (HL),E", 0x73, 0, 2, fgb_ld_p_hl_e),
    INS("LD (HL),H", 0x74, 0, 2, fgb_ld_p_hl_h),
    INS("LD (HL),L", 0x75, 0, 2, fgb_ld_p_hl_l),
    INS("HALT", 0x76, 0, 1, fgb_halt),
    INS("LD (HL),A", 0x77, 0, 2, fgb_ld_p_hl_a),
    INS("LD A,B", 0x78, 0, 1, fgb_ld_a_b),
    INS("LD A,C", 0x79, 0, 1, fgb_ld_a_c),
    INS("LD A,D", 0x7A, 0, 1, fgb_ld_a_d),
    INS("LD A,E", 0x7B, 0, 1, fgb_ld_a_e),
    INS("LD A,H", 0x7C, 0, 1, fgb_ld_a_h),
    INS("LD A,L", 0x7D, 0, 1, fgb_ld_a_l),
    INS("LD A,(HL)", 0x7E, 0, 2, fgb_ld_a_p_hl),
    INS("LD A,A", 0x7F, 0, 1, fgb_ld_a_a),

    INS("ADD A,B", 0x80, 0, 1, fgb_add_a_b),
    INS("ADD A,C", 0x81, 0, 1, fgb_add_a_c),
    INS("ADD A,D", 0x82, 0, 1, fgb_add_a_d),
    INS("ADD A,E", 0x83, 0, 1, fgb_add_a_e),
    INS("ADD A,H", 0x84, 0, 1, fgb_add_a_h),
    INS("ADD A,L", 0x85, 0, 1, fgb_add_a_l),
    INS("ADD A,(HL)", 0x86, 0, 2, fgb_add_a_p_hl),
    INS("ADD A,A", 0x87, 0, 1, fgb_add_a_a),
    INS("ADC A,B", 0x88, 0, 1, fgb_adc_a_b),
    INS("ADC A,C", 0x89, 0, 1, fgb_adc_a_c),
    INS("ADC A,D", 0x8A, 0, 1, fgb_adc_a_d),
    INS("ADC A,E", 0x8B, 0, 1, fgb_adc_a_e),
    INS("ADC A,H", 0x8C, 0, 1, fgb_adc_a_h),
    INS("ADC A,L", 0x8D, 0, 1, fgb_adc_a_l),
    INS("ADC A,(HL)", 0x8E, 0, 2, fgb_adc_a_p_hl),
    INS("ADC A,A", 0x8F, 0, 1, fgb_adc_a_a),

    INS("SUB B", 0x90, 0, 1, fgb_unimplemented_0),
    INS("SUB C", 0x91, 0, 1, fgb_unimplemented_0),
    INS("SUB D", 0x92, 0, 1, fgb_unimplemented_0),
    INS("SUB E", 0x93, 0, 1, fgb_unimplemented_0),
    INS("SUB H", 0x94, 0, 1, fgb_unimplemented_0),
    INS("SUB L", 0x95, 0, 1, fgb_unimplemented_0),
    INS("SUB (HL)", 0x96, 0, 2, fgb_unimplemented_0),
    INS("SUB A", 0x97, 0, 1, fgb_unimplemented_0),
    INS("SBC A,B", 0x98, 0, 1, fgb_unimplemented_0),
    INS("SBC A,C", 0x99, 0, 1, fgb_unimplemented_0),
    INS("SBC A,D", 0x9A, 0, 1, fgb_unimplemented_0),
    INS("SBC A,E", 0x9B, 0, 1, fgb_unimplemented_0),
    INS("SBC A,H", 0x9C, 0, 1, fgb_unimplemented_0),
    INS("SBC A,L", 0x9D, 0, 1, fgb_unimplemented_0),
    INS("SBC A,(HL)", 0x9E, 0, 2, fgb_unimplemented_0),
    INS("SBC A,A", 0x9F, 0, 1, fgb_unimplemented_0),

    INS("AND B", 0xA0, 0, 1, fgb_unimplemented_0),
    INS("AND C", 0xA1, 0, 1, fgb_unimplemented_0),
    INS("AND D", 0xA2, 0, 1, fgb_unimplemented_0),
    INS("AND E", 0xA3, 0, 1, fgb_unimplemented_0),
    INS("AND H", 0xA4, 0, 1, fgb_unimplemented_0),
    INS("AND L", 0xA5, 0, 1, fgb_unimplemented_0),
    INS("AND (HL)", 0xA6, 0, 2, fgb_unimplemented_0),
    INS("AND A", 0xA7, 0, 1, fgb_unimplemented_0),
    INS("XOR B", 0xA8, 0, 1, fgb_unimplemented_0),
    INS("XOR C", 0xA9, 0, 1, fgb_unimplemented_0),
    INS("XOR D", 0xAA, 0, 1, fgb_unimplemented_0),
    INS("XOR E", 0xAB, 0, 1, fgb_unimplemented_0),
    INS("XOR H", 0xAC, 0, 1, fgb_unimplemented_0),
    INS("XOR L", 0xAD, 0, 1, fgb_unimplemented_0),
    INS("XOR (HL)", 0xAE, 0, 2, fgb_unimplemented_0),
    INS("XOR A", 0xAF, 0, 1, fgb_unimplemented_0),

    INS("OR B", 0xB0, 0, 1, fgb_unimplemented_0),
    INS("OR C", 0xB1, 0, 1, fgb_unimplemented_0),
    INS("OR D", 0xB2, 0, 1, fgb_unimplemented_0),
    INS("OR E", 0xB3, 0, 1, fgb_unimplemented_0),
    INS("OR H", 0xB4, 0, 1, fgb_unimplemented_0),
    INS("OR L", 0xB5, 0, 1, fgb_unimplemented_0),
    INS("OR (HL)", 0xB6, 0, 2, fgb_unimplemented_0),
    INS("OR A", 0xB7, 0, 1, fgb_unimplemented_0),
    INS("CP B", 0xB8, 0, 1, fgb_unimplemented_0),
    INS("CP C", 0xB9, 0, 1, fgb_unimplemented_0),
    INS("CP D", 0xBA, 0, 1, fgb_unimplemented_0),
    INS("CP E", 0xBB, 0, 1, fgb_unimplemented_0),
    INS("CP H", 0xBC, 0, 1, fgb_unimplemented_0),
    INS("CP L", 0xBD, 0, 1, fgb_unimplemented_0),
    INS("CP (HL)", 0xBE, 0, 2, fgb_unimplemented_0),
    INS("CP A", 0xBF, 0, 1, fgb_unimplemented_0),

    INS("RET NZ", 0xC0, 0, 2, fgb_unimplemented_0),
    INS("POP BC", 0xC1, 0, 3, fgb_unimplemented_0),
    INS("JP NZ,0x%04X", 0xC2, 2, 3, fgb_unimplemented_2),
    INS("JP 0x%04X", 0xC3, 2, 4, fgb_unimplemented_2),
    INS("CALL NZ,0x%04X", 0xC4, 2, 3, fgb_unimplemented_2),
    INS("PUSH BC", 0xC5, 0, 4, fgb_unimplemented_0),
    INS("ADD A,0x%02X", 0xC6, 1, 2, fgb_unimplemented_1),
    INS("RST 0", 0xC7, 0, 4, fgb_unimplemented_0),
    INS("RET Z", 0xC8, 0, 2, fgb_unimplemented_0),
    INS("RET", 0xC9, 0, 4, fgb_unimplemented_0),
    INS("JP Z,0x%04X", 0xCA, 2, 3, fgb_unimplemented_2),
    INS(NULL, 0xCB, 0, 0, fgb_unimplemented_0), // CB prefix
    INS("CALL Z,0x%04X", 0xCC, 2, 3, fgb_unimplemented_2),
    INS("CALL 0x%04X", 0xCD, 2, 6, fgb_unimplemented_2),
    INS("ADC A,0x%02X", 0xCE, 1, 2, fgb_unimplemented_1),
    INS("RST 1", 0xCF, 0, 4, fgb_unimplemented_0),

    INS("RET NC", 0xD0, 0, 2, fgb_unimplemented_0),
    INS("POP DE", 0xD1, 0, 3, fgb_unimplemented_0),
    INS("JP NC,0x%04X", 0xD2, 2, 3, fgb_unimplemented_2),
    INS(NULL, 0xD3, 0, 0, fgb_unimplemented_0),
    INS("CALL NC,0x%04X", 0xD4, 2, 3, fgb_unimplemented_2),
    INS("PUSH DE", 0xD5, 0, 4, fgb_unimplemented_0),
    INS("SUB 0x%02X", 0xD6, 1, 2, fgb_unimplemented_1),
    INS("RST 2", 0xD7, 0, 4, fgb_unimplemented_0),
    INS("RET C", 0xD8, 0, 2, fgb_unimplemented_0),
    INS("RETI", 0xD9, 0, 4, fgb_unimplemented_0),
    INS("JP C,0x%04X", 0xDA, 2, 3, fgb_unimplemented_2),
    INS(NULL, 0xDB, 0, 0, fgb_unimplemented_0),
    INS("CALL C,0x%04X", 0xDC, 2, 3, fgb_unimplemented_2),
    INS(NULL, 0xDD, 0, 0, fgb_unimplemented_0),
    INS("SBC A,0x%02X", 0xDE, 1, 2, fgb_unimplemented_1),
    INS("RST 3", 0xDF, 0, 4, fgb_unimplemented_0),

    INS("LDH (0x%02X),A", 0xE0, 1, 3, fgb_unimplemented_1),
    INS("POP HL", 0xE1, 0, 3, fgb_unimplemented_0),
    INS("LD (C),A", 0xE2, 0, 2, fgb_unimplemented_0),
    INS(NULL, 0xE3, 0, 0, fgb_unimplemented_0),
    INS(NULL, 0xE4, 0, 0, fgb_unimplemented_0),
    INS("PUSH HL", 0xE5, 0, 4, fgb_unimplemented_0),
    INS("AND 0x%02X", 0xE6, 1, 2, fgb_unimplemented_1),
    INS("RST 4", 0xE7, 0, 4, fgb_unimplemented_0),
    INS("ADD SP,0x%02X", 0xE8, 1, 4, fgb_unimplemented_1),
    INS("JP (HL)", 0xE9, 0, 1, fgb_unimplemented_0),
    INS("LD (0x%04X),A", 0xEA, 2, 4, fgb_unimplemented_2),
    INS(NULL, 0xEB, 0, 0, fgb_unimplemented_0),
    INS(NULL, 0xEC, 0, 0, fgb_unimplemented_0),
    INS(NULL, 0xED, 0, 0, fgb_unimplemented_0),
    INS("XOR 0x%02X", 0xEE, 1, 2, fgb_unimplemented_1),
    INS("RST 5", 0xEF, 0, 4, fgb_unimplemented_0),

    INS("LDH A,(0x%02X)", 0xF0, 1, 3, fgb_unimplemented_1),
    INS("POP AF", 0xF1, 0, 3, fgb_unimplemented_0),
    INS("LD A,(C)", 0xF2, 0, 2, fgb_unimplemented_0),
    INS(NULL, 0xF3, 0, 0, fgb_unimplemented_0),
    INS(NULL, 0xF4, 0, 0, fgb_unimplemented_0),
    INS("PUSH AF", 0xF5, 0, 4, fgb_unimplemented_0),
    INS("OR 0x%02X", 0xF6, 1, 2, fgb_unimplemented_1),
    INS("RST 6", 0xF7, 0, 4, fgb_unimplemented_0),
    INS("LD HL,SP+0x%02X", 0xF8, 1, 3, fgb_unimplemented_1),
    INS("LD SP,HL", 0xF9, 0, 2, fgb_unimplemented_0),
    INS("LD A,(0x%04X)", 0xFA, 2, 4, fgb_unimplemented_2),
    INS("DI", 0xFB, 0, 1, fgb_unimplemented_0),
    INS(NULL, 0xFC, 0, 0, fgb_unimplemented_0),
    INS(NULL, 0xFD, 0, 0, fgb_unimplemented_0),
    INS("CP 0x%02X", 0xFE, 1, 2, fgb_unimplemented_1),
    INS("RST 7", 0xFF, 0, 4, fgb_unimplemented_0),
};
